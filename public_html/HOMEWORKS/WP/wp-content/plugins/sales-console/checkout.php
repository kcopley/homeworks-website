<?phpinclude 'bookmethods.php';$table = new TableArr(border(0).cellpadding(0).cellspacing(0).width(100),    get_add_item_box(),    get_current_books());$table->Render();function get_add_item_box() {    return new Row(        new Column(            new Form(id('cart').name('cart'),                new TableArr(border(0).cellpadding(0).cellspacing(0).width(100).id('formtable'),                    new Row(                        new Column(align('right').width(7), new Label(new TextRender('ID:'))),                        new Column(width(93), new Input(id(checkout_constants::$barcode).name(checkout_constants::$barcode).type('text')))                    ),                    new Row(                        new Column(align('right'), new Label(new TextRender('ISBN:'))),                        new Column(new Input(id(checkout_constants::$isbn).name(checkout_constants::$isbn).type('text')))                    )                ),                new Input(name(checkout_constants::$quantity).type('hidden').value(1)),                page_action::InputAction(action_types::$add_item_checkout),                button('Add Item')            )        )    );}function get_current_books() {}?><table border="0" cellpadding="0" cellspacing="0" width="100%">    <tr>        <td align="left" valign="top"> <?php            add_item_formatting();            //Switch statement            switch ($_REQUEST[request_page_action()]) {                case request_sale_add_item_action():                    add_item();                    break;                case request_sale_remove_item_action():                    remove_item();                    break;                case request_sale_credit_action():                    add_credit();                    break;                case request_sale_remove_credit_action():                    remove_credit();                    break;                case request_sale_clear_action():                    clear_cart();                    break;            };            if ($_SESSION[request_sale_session_cart()] && !empty($_SESSION[request_sale_session_cart()])) {                bookbag_list_formatting();            } ?>        </td>        <td align="left" id="payment-column" valign="top">            <?php            credit_box_formatting();            if ($_REQUEST[request_page_action()] == request_processing() || $_REQUEST[request_sales_Auth()]) {                process_auth();                //Separate                //print_formatting();            }            else {                ?>                <script type="text/javascript">                    jQuery(document).ready(                        function () {                            jQuery("input[value$='credit']").click(function () {                                jQuery(".desc").hide();                                jQuery("#credit").show();                            });                            jQuery("input[value$='check']").click(function () {                                jQuery(".desc").hide();                                jQuery("#check").show();                            });                            jQuery("input[value$='cash']").click(function () {                                jQuery(".desc").hide();                                jQuery("#cash").show();                            });                            jQuery("input[value$='phone']").click(function () {                                jQuery(".desc").hide();                                jQuery("#phone").show();                            });                        }                    );                </script>                <script type="text/javascript">                    function setFromCCS() {                        document.getElementById("swipe").blur(function (e) {                            e.preventDefault();                        });                        var ccs = document.getElementById("swipe").value;                        var index1 = ccs.indexOf("%B") + 2;                        var index2 = ccs.indexOf("^") + 1;                        var index3 = ccs.indexOf("^", index2 + 1) + 1;                        var cardNumber = ccs.substring(index1, index2 - 1);                        var expMonth = ccs.substr(index3, 2);                        var expYear = ccs.substr(index3 + 2, 2);                        var holderName = ccs.substring(index2, index3 - 1);                        var index4 = holderName.indexOf("/");                        var temp1 = holderName.substring(0, index4);                        var temp2 = holderName.substring(index4 + 1);                        holderName = temp2 + ' ' + temp1;                        document.getElementById("swipe").style.display = "none";                        document.getElementById("ch").value = holderName;                        document.getElementById("cn").value = cardNumber;                        document.getElementById("cm").value = expMonth;                        document.getElementById("cy").value = expYear;                    }                    ;                </script>                <table width="100%" border="0" cellspacing="0" cellpadding="0">                    <tr>                        <td valign="top">                            <?php                            if ($_REQUEST['cn']) {                                $_SESSION['email'] = $_REQUEST["email"];                                $_SESSION['customer'] = $_REQUEST["ch"]; ?>                                <h4 style="font-size: 14px;">Verify customer information</h4>                                <p>                                    <strong>Name:</strong>                                    <?php echo $_REQUEST['ch']; ?><br/>                                    <strong>Contact:</strong>                                    <?php echo $_REQUEST['email']; ?><br/>                                    <strong>Billing address:</strong>                                    <?php echo $_REQUEST['AVSADDR']; ?><br/>                                    <?php echo $_REQUEST['AVSCITY']; ?>                                    <?php if ($_REQUEST['AVSSTATE'] != "") { ?>, <?php }; ?>                                    <?php echo $_REQUEST['AVSSTATE']; ?>                                    <?php echo $_REQUEST['AVSZIP']; ?>                                </p>                                <form id="TRANSFIRST" method="POST" action="https://webservices.primerchants.com/billing/TransactionCentral/processCC.asp?" name="frmReturn" id="frmReturn">                                    <input type="hidden" name="MerchantID" id="100846" value="<?php echo get_option('merchantid'); ?>">                                    <input type="hidden" name="RegKey" id="5QJ6J3H3YSYZAAZA" value="<?php echo get_option('regkey'); ?>">                                    <input type="hidden" name="CCRURL" value="<?php echo admin_url('admin.php?page=conference-sales&', 'https'); ?>">                                    <input type="hidden" name="ConfirmPage" value="Y">                                    <input type="hidden" name="RefID" value="<?php echo $newinvoice; ?>">                                    <input type="hidden" name="Amount" value="<?php echo $cost; ?>">                                    <input type="hidden" name="TaxAmount" value="<?php echo $tax; ?>">                                    <input type="hidden" name="TaxIndicator" value="1">                                    <input type="hidden" name="NameonAccount" value="<?php echo $_REQUEST['ch']; ?>">                                    <input type="hidden" name="AccountNo" value="<?php echo $_REQUEST['cn']; ?>">                                    <input type="hidden" name="CCMonth" value="<?php echo $_REQUEST['cy']; ?>">                                    <input type="hidden" name="CCYear" value="<?php echo $_REQUEST['cm']; ?>">                                    <input type="hidden" name="CVV2" value="<?php echo $_REQUEST['CVV2']; ?>">                                    <input type="hidden" name="AVSADDR" value="<?php echo $_REQUEST['AVSADDR']; ?>">                                    <input type="hidden" name="AVSZIP" value="<?php echo $_REQUEST['AVSZIP']; ?>">                                    <input type="hidden" name="ShipToZipCode" value="<?php echo $_REQUEST['AVSZIP']; ?>">                                    <input type="hidden" name="USER1" value="credit">                                    <input class="button-primary" type="submit" value="Process Credit Payment"/>                                </form>                                <?php                            }                            else {                                get_customer_cash_info();                                get_customer_check_info();                                get_customer_credit_info();                            }                            ?>                        </td>                    </tr>                    <tr>                        <td height="35px" valign="top">                            <h4><strong><?php echo 'Due: $'.number_format(get_total(), 2); ?></strong></h4>                        </td>                    </tr>                    <tr>                            <td valign="top">                                <p id="paytype"><strong>Payment type:</strong><br />                                    <input type="radio" name="<?php echo sales_payment_type() ?>" value="<?php echo sales_payment_cash() ?>"> Cash<br>                                    <input type="radio" name="<?php echo sales_payment_type() ?>" value="<?php echo sales_payment_check() ?>"> Check<br>                                    <input type="radio" name="<?php echo sales_payment_type() ?>" value="<?php echo sales_payment_phone() ?>"> Phone<br>                                    <input type="radio" name="<?php echo sales_payment_type() ?>" value="<?php echo sales_payment_credit() ?>"> Credit                                </p>                            </td>                        </tr>                </table>                <?php            }            ?>        </td>    </tr></table><?phpfunction process_auth() {    if ($_REQUEST[request_sales_Auth()] == sales_AuthCodeDeclined()) {        $cw2 = $_REQUEST[request_sales_CCResponse()];        if ($cw2 == sales_purchase_error()) {            ?>            <h1>Purchase Error</h1>            <h4>There was an error processing the order.</h4><?php        }        else if ($cw2 == sales_incorrect_number()) {            ?>            <h1>Card Error</h1>            <h4>Credit card information does not match.</h4><?php        }        else {            ?>            <h1>Processing Error</h1>            <h4>Your card could not be identified.</h4><?php        }    }    else {        $newinvoice    = get_next_invoice();        $refund = $_REQUEST[sales_customer_cash_payment_amount()] - get_total();        $transaction = array(            'post_title' => $newinvoice,            'post_status' => 'publish',            'post_author' => 1,            'post_category' => array(                1            ),            'post_type' => 'transactions'        );        $postid = wp_insert_post($transaction);        set_transaction_id($postid, $newinvoice);        set_transaction_customer_name($postid, $_REQUEST[sales_customer_name()]);        set_transaction_customer_email($postid, $_REQUEST[sales_customer_email()]);        set_transaction_customer_address($postid, "Conference Sale");        set_transaction_taxrate($postid, str_replace('$', '', get_option('ctaxrate') / 100));        set_transaction_books($postid, get_cart_books());        set_transaction_credits($postid, get_credits());        set_transaction_date($postid, date('Y-m-d'));        foreach ($_SESSION[request_sale_session_cart()] as $product => $qty) {            $consigners = get_book_consigners($product);            $soldconsigner = array_shift($consigners);            if ($soldconsigner != get_consigner_owner_id()) {                remove_book_and_consigner($product, $soldconsigner);                consigner_add_sold_book($soldconsigner, $product);            }            if (get_consigner_count($product) <= 0) {                set_book_availablity($product, 'false');            };            add_book_numsold($product, (int)$qty);        }        if ($_REQUEST[sales_payment_type()] == sales_payment_cash()) {            set_transaction_payment_type($postid, 'cash');            set_transaction_paid($postid, 'Yes');            ?>            <h4>Refund: $<?php            echo $refund;            ?></h4><?php        }        else if ($_REQUEST[sales_payment_type()] == sales_payment_check()) {            update_post_meta($postid, '_cmb_payment_type', 'check');            update_post_meta($postid, '_cmb_customer_payment', 'Yes');            ?>            <h4>Check payment received.</h4><?php        }        else if ($_REQUEST[sales_payment_type()] == sales_payment_check()) {            update_post_meta($postid, '_cmb_payment_type', 'check');            update_post_meta($postid, '_cmb_customer_payment', 'Yes');            ?>            <h4>Check payment received.</h4><?php        }        else if ($_REQUEST['USER1'] == "credit") {            $transid = $_REQUEST['TransID'];            update_post_meta($postid, '_cmb_transfirst', $transid);            update_post_meta($postid, '_cmb_payment_type', 'credit');            ?>            <h4>Payment received at TransFirst/Transaction Central</h4><?php        }    }}function print_formatting() {    ?>    <div style="display: none;">        <div id="toPrint">            <p style="text-align: center;"><strong>Home Works for Books</strong><br>                <em>Your homeschool connection for discounted new and used homeschool materials!</em></p>            <p style="text-align: center;"><?php                echo get_option('invoiceaddress');                ?><br>                <strong>Phone:</strong> <?php                echo get_option('invoicephone');                ?><br>                Come visit us online at <?php                echo get_option('invoiceURL');                ?></p>            <p>&nbsp;</p>            <table border="0" cellpadding="0" cellspacing="0" width="100%">                <tr>                    <td align="left" colspan="3" valign="top"><?php                        echo date("Y/m/d H:i:s");                        ?></td>                </tr>                <tr>                    <td align="left" colspan="3" valign="top"><?php                        global $current_user;                        get_currentuserinfo();                        ?>Cashier: <?php                        echo $current_user->user_firstname;                        ?></td>                </tr>                <tr>                    <td align="left" colspan="3" valign="middle">                        <hr>                    </td>                </tr><?php                foreach ($_SESSION['cart'] as $product => $qty):                    $row = get_post($product);                    $price = get_post_meta($product, '_cmb_resource_price', true);                    $amount = str_replace("$", "", $price);                    $line_cost = $amount * $qty;                    $total += get_post_meta($product, '_cmb_resource_price', true) * $qty;                    $taxpercent = get_option('ctaxrate') / 100;                    $tax = number_format($taxpercent * $total, 2);                    $credit = number_format($_SESSION['credit'], 2);                    $order = number_format($total - $credit, 2);                    $cost = number_format($total + $tax - $credit, 2);                    ?>                    <tr>                    <td align="left" colspan="2" valign="top">(<?php                        echo $qty;                        ?> ) <?php                        echo $row->post_title;                        ?></td>                    <td valign="top" width="15%">$<?php                        echo number_format($line_cost, 2);                        ?></td>                    </tr><?php                endforeach;                ?>                <tr>                    <td align="left" colspan="3" valign="middle">                        <hr>                    </td>                </tr>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%"><strong>Subtotal:</strong>&nbsp;&nbsp;</td>                    <td valign="top"><strong>$<?php                            echo number_format($total, 2);                            ?></strong></td>                </tr>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%">Credit:&nbsp;&nbsp;</td>                    <td valign="top">$<?php                        echo number_format($credit, 2);                        ?></td>                </tr>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%">Tax:&nbsp;&nbsp;</td>                    <td valign="top">$<?php                        echo $tax;                        ?></td>                </tr>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%">                        <hr>                    </td>                    <td valign="top">                        <hr>                    </td>                </tr>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%"><strong>TOTAL:</strong>&nbsp;&nbsp;</td>                    <td valign="top"><strong>$<?php                            echo $cost;                            ?></strong></td>                </tr><?php                $paytype = $_REQUEST['paytype'];                if ($paytype == "credit" or $_REQUEST['USER1'] == "credit") {                } else {                    ?>                    <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%"><span style="text-transform: uppercase;"><?php                            echo $paytype;                            ?>:</span>&nbsp;&nbsp;</td>                    <td valign="top">$<?php                        echo $_REQUEST['payment'];                        ?></td>                    </tr><?php                }                ?>                <tr>                    <td valign="top">&nbsp;</td>                    <td align="right" valign="top" width="10%">Change:&nbsp;&nbsp;</td>                    <td valign="top">$<?php                        echo $refund;                        ?></td>                </tr>            </table>            <p style="text-align: center;"><?php                echo get_option('invoicepromo');                ?></p>            <p style="text-align: center;"><strong>Invoice:</strong> #<?php                echo $invoice;                ?><br>                Customer Copy</p>        </div>    </div>    <table border="0" cellpadding="0" cellspacing="0" width="100%">        <tr>            <td align="left" valign="top"><input class="button-primary" onclick="printContent('toPrint');"                                                 type="button" value="Print invoice">&nbsp;&nbsp;&nbsp;</td>            <td align="left" valign="top">                <form action="%3C?php%20echo%20admin_url('admin.php?page=conference-sales',%20'https');%20?%3E"                      id="clear" method="post" name="clear">                    <input name="product_id" type="hidden" value="null"> <input name="action" type="hidden"                                                                                value="empty"> <input                        class="button-primary" type="submit" value="New order">                </form>            </td>        </tr>    </table>    <?php}function get_customer_credit_info() {    ?>    <div id="credit" class="desc" style="display: none; margin-left: 25px;">        <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0">            <tr>                <td>&nbsp;</td>                <td><input id="swipe" type="text" value=""                           placeholder="Swipe card &hellip;"/></td>            <tr>                <td align="right">                    <form id="TRANSFIRST" method="POST" action="" name="creditform">                        <input type="hidden" name="TrackData" id="TrackData"/>                        <label for="ch">Name on card:</label>&nbsp;                </td>                <td><input type="text" name="ch" id="ch" onclick="setFromCCS()"></td>            </tr>            <tr>                <td align="right"><label for="email">Email address:</label>&nbsp;</td>                <td><input type="text" name="email"></td>            </tr>            <tr>                <td align="right"><label for="cn">Credit card #:</label>&nbsp;</td>                <td><input type="text" name="cn" id="cn"></td>            </tr>            <tr>                <td align="right"><label for="cm">Expires:</label>&nbsp;</td>                <td><input type="text" name="cy" id="cy" maxlength="2" size="2"                           placeholder="<?php echo date('m'); ?>">/<input type="text"                                                                          name="cm" id="cm"                                                                          maxlength="2"                                                                          size="2"                                                                          placeholder="<?php echo substr(date('Y'), -2); ?>">                </td>            </tr>            <tr>                <td align="right"><label for="CVV2">Verification #:</label>&nbsp;</td>                <td><input type="text" name="CVV2" maxlength="4" size="4"></td>            </tr>            <tr>                <td align="right"><label for="AVSADDR">Address:</label>&nbsp;&nbsp;</td>                <td><input type="text" name="AVSADDR"></td>            </tr>            <tr>                <td align="right"><label for="AVSCITY">City:</label>&nbsp;</td>                <td><input type="text" name="AVSCITY"></td>            </tr>            <tr>                <td align="right"><label for="AVSSTATE">State:</label>&nbsp;</td>                <td>                    <?php                    state_select();                    ?>                </td>            </tr>            <tr>                <td align="right"><label for="AVSZIP">ZIP:</label>&nbsp;</td>                <td><input type="text" name="AVSZIP"></td>            </tr>            <tr>                <td>&nbsp;</td>                <td><input class="button-primary" type="submit" value="Continue"/></td>            </tr>        </table>        </form>    </div>    <?php}function get_customer_check_info() {    ?>    <div id="check" class="desc" style="display: none;">        <form method="POST" action="" name="checkform">            <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0">                <tr>                    <td align="right">                        <input type="hidden" name="product_id" value="null"/>                        <input type="hidden" name="paytype" value="check"/>                        <label for="customer">Name on check:</label>&nbsp;                    </td>                    <td><input type="text" name="customer"></td>                </tr>                <tr>                    <td align="right"><label for="email">Email address:</label>&nbsp;</td>                    <td>                        <input type="text" name="email">                        <input type="hidden" name="action" value="process"/>                        <input type="hidden" name="cost" value="<?php echo $order; ?>"/>                        <input type="hidden" name="tax" value="<?php echo $tax; ?>"/>                        <input type="hidden" name="payment" value="<?php echo $cost; ?>"/>                        <input type="hidden" name="RefNo"                               value="<?php echo $newinvoice; ?>"/>                    </td>                </tr>                <tr>                    <td>&nbsp;</td>                    <td><input class="button-primary" type="submit" value="Check Payment"/>                    </td>                </tr>            </table>        </form>    </div>    <?php}function get_customer_cash_info() {    ?>    <div id="cash" class="desc" style="display: none;">        <form method="POST" action="" name="cashform">            <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0">                <tr>                    <td align="right">                        <input type="hidden" name="<?php echo sales_payment_type(); ?>" value="<?php echo sales_payment_cash(); ?>"/>                        <label for="<?php echo sales_customer_name(); ?>">Customer name:</label>&nbsp;                    </td>                    <td>                        <input type="text" name="<?php echo sales_customer_name(); ?>">                    </td>                </tr>                <tr>                    <td align="right"><label for="<?php echo sales_customer_email(); ?>">Email address:</label>&nbsp;</td>                    <td><input type="text" name="<?php echo sales_customer_email(); ?>"></td>                </tr>                <tr>                    <td align="right">                        <input type="hidden" name="<?php echo request_page_action(); ?>" value="<?php echo request_processing(); ?>"/>                        Amount:&nbsp;$&nbsp;                    </td>                    <td>                        <input type="text" name="<?php echo sales_customer_cash_payment_amount(); ?>"/>                    </td>                </tr>                <tr>                    <td>&nbsp;</td>                    <td>                        <input class="button-primary" type="submit" value="Cash Payment"/>                    </td>                </tr>            </table>        </form>    </div>    <?php}function get_customer_phone_info() {    ?>    <div id="phone" class="desc" style="display: none;">        <form method="POST" action="" name="phoneform">            <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0">                <tr>                    <td align="right">                        <input type="hidden" name="product_id" value="null"/>                        <input type="hidden" name="paytype" value="cash"/>                        <label for="customer">Customer name:</label>&nbsp;                    </td>                    <td><input type="text" name="customer"></td>                </tr>                <tr>                    <td align="right"><label for="email">Email address:</label>&nbsp;</td>                    <td><input type="text" name="email"></td>                </tr>                <tr>                    <td align="right">                        <input type="hidden" name="<?php echo request_page_action() ?>" value="<?php echo request_processing() ?>"/>                        <input type="hidden" name="cost" value="<?php echo $order; ?>"/>                        <input type="hidden" name="tax" value="<?php echo $tax; ?>"/>                        <input type="hidden" name="RefNo"                               value="<?php echo $newinvoice; ?>"/>                        Amount:&nbsp;$&nbsp;                    </td>                    <td><input type="text" name="payment"/></td>                </tr>                <tr>                    <td>&nbsp;</td>                    <td><input class="button-primary" type="submit" value="Cash Payment"/>                    </td>                </tr>            </table>        </form>    </div>    <?php}function bookbag_list_formatting() { ?>    <p>&nbsp;</p>                <table border="0" cellpadding="0" cellspacing="0" id="bookbag" width="100%">                    <?php                    list_books();                    ?>    <tr>        <td colspan="5">            <hr>        </td>    </tr>    <tr>        <td colspan="2">&nbsp;</td>        <td align="right"><strong>Subtotal:</strong>&nbsp;&nbsp;</td>        <td>            <strong>                <?php                echo '$'.number_format(get_subtotal(), 2);                ?>            </strong>        </td>        <td></td>    </tr>    <tr class="calculate">        <?php        $credit = get_credit_total();        if ($credit != 0) {            ?>            <td colspan="2"></td>            <td align="right">Credit:</td>            <td>                <?php                echo '$'.number_format(get_credit_total(), 2);                ?>            </td>            <td>&larr; Discount applied</td><?php        }        ?>    </tr>    <tr class="calculate">        <td colspan="2">&nbsp;</td>        <td align="right">Tax:&nbsp;&nbsp;</td>        <td><?php            echo '$'.number_format(get_tax_total(), 2);            ?>        </td>        <td>&larr;            <?php            echo '$'.get_option('ctaxrate').'% applied';            ?>        </td>    </tr>    <tr class="calculate">        <td colspan="2">&nbsp;</td>        <td colspan="3">            <hr>        </td>        <td>&nbsp;</td>    </tr>    <tr class="calculate">        <td colspan="2">&nbsp;</td>        <td align="right"><strong>TOTAL:</strong>&nbsp;&nbsp;</td>        <td>            <strong>                <?php                echo '$'.number_format(get_total(), 2);                ?>            </strong>        </td>        <td>            <form action="" id="empty" method="post" name="empty">                <input name="product_id" type="hidden" value="null">                <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo request_sale_clear_action() ?>">                <input class="button-primary" type="submit" value="Empty bookbag">            </form>        </td>    </tr>    </table>    <?php}function credit_box_formatting() {    ?>    <div id="credit_details">        <h4>Discount</h4>        <form action="" id="discount" method="post" name="discount">            <table width="100%">                <tr>                    <td align="right"><label>Type:</label>&nbsp;</td>                    <td><input name="<?php echo request_sale_credit_name() ?>" type="text"></td>                </tr>                <tr>                    <td align="right"><label>Amount:</label>&nbsp;$</td>                    <td><input name="<?php echo request_sale_credit() ?>" type="text"></td>                </tr>            </table><input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo request_sale_credit_action() ?>">            <input class="button-primary" name="discount" type="submit" value="Update">        </form>    </div>    <?php}function add_item(){    $barcode_id = $_REQUEST[request_sale_id()];    $ISBN = $_REQUEST[request_sale_isbn()];    $quantity = $_REQUEST[request_sale_quantity()];    $book = null;    if ($_REQUEST[request_sale_id()]) {        $query = new WP_Query(            array(                'post_type' => 'bookstore',                'meta_key' => '_cmb_resource_barcode',                'meta_value' => $barcode_id,                'numberposts' => 1,                'exact' => 1,            )        );        while ($query->have_posts()):            $query->the_post();            global $post;            $book = $post->ID;            break;        endwhile;    }    else if ($_REQUEST['ISBN']) {        $query = new WP_Query(            array(                'post_type' => 'bookstore',                'meta_key' => '_cmb_resource_isbn',                'meta_value' => $ISBN,                'numberposts' => 1,                'exact' => 1,            )        );        while ($query->have_posts()):            $query->the_post();            global $post;            $book = $post->ID;            break;        endwhile;    }    add_item_to_cart($book, $quantity);}function list_books() {    ?>    <thead>    <tr>        <th align="left" width="55%">Item</th>        <th width="5%">Quantity</th>        <th width="10%">&nbsp;</th>        <th align="left" class="price" width="10%">Price</th>        <th width="20%">&nbsp;</th>    </tr>    </thead>    <?php    if ($_SESSION[request_sale_session_cart()]) {        foreach ($_SESSION[request_sale_session_cart()] as $book => $quantity) {            if (empty($book) || empty($quantity)){ continue; }            $price = str_replace("$", "", get_book_saleprice($book)); //just in case any slip by            $line_cost = $price * $quantity;            ?>            <tr>            <td>                <?php                echo get_the_title($book);                ?>            </td>            <td align="center">                <table>                    <tr>                        <?php                        echo $quantity;                        ?>                    </tr>                    <tr>                    <form action="" class="remove" method="post">                        <input name="<?php echo request_selected_book() ?>" type="hidden" value="<?php echo $book; ?>"/>                        <input name="<?php echo request_page_action() ?>" type="hidden"                               value="<?php echo request_sale_remove_item_action() ?>"/>                        <input name="<?php echo request_sale_remove_amount() ?>" type="hidden"                               value="<?php echo sale_remove_one() ?>"/>                        <input id="checkoutdash" type="submit" value="-"/>                      </tr>                    <tr>                    <form action="" class="remove" method="post">                        <input name="<?php echo request_selected_book() ?>" type="hidden" value="<?php echo $book; ?>"/>                        <input name="<?php echo request_page_action() ?>" type="hidden"                               value="<?php echo request_sale_remove_item_action() ?>"/>                        <input name="<?php echo request_sale_remove_amount() ?>" type="hidden"                               value="<?php echo sale_remove_all() ?>"/>                        <input id="checkoutx" type="submit" value="X"/>                    </form>                    </tr>                </table>            </td>            <td>&nbsp;</td>            <td>                <?php echo '$' . number_format($line_cost, 2); ?></td>            <td>&nbsp;</td>            </tr><?php        }    }}function get_total() {    return get_subtotal() + get_tax_total();}function get_subtotal() {    $total = 0;    if ($_SESSION[request_sale_session_cart()]) {        foreach ($_SESSION[request_sale_session_cart()] as $book => $quantity) {            $price = get_book_saleprice($book);            $total = $total + $quantity * $price;        }    }    return $total - get_credit_total();}function remove_item() {    $product_removed = $_REQUEST[request_selected_book()];    $removeQuantity = $_REQUEST[request_sale_remove_amount()];    remove_item_from_cart($product_removed, $removeQuantity);}function remove_item_from_cart($product_id, $removeType) {    if ($_SESSION[request_sale_session_cart()]) {        if (array_key_exists($product_id, $_SESSION[request_sale_session_cart()])) {            if ($removeType == sale_remove_all()) {                unset($_SESSION[request_sale_session_cart()][$product_id]);            }            else {                $_SESSION[request_sale_session_cart()][$product_id] -= 1;                if ($_SESSION[request_sale_session_cart()][$product_id] <= 0) {                    unset($_SESSION[request_sale_session_cart()][$product_id]);                }            }        }    }}function add_item_to_cart($product_id, $quantity) {    if ($product_id != null) {        if ($_SESSION[request_sale_session_cart()]) {            if (array_key_exists($product_id, $_SESSION[request_sale_session_cart()])) {                $_SESSION[request_sale_session_cart()][$product_id] += $quantity;            }            else {                $_SESSION[request_sale_session_cart()][$product_id] = $quantity;            }        }        else {            $_SESSION[request_sale_session_cart()] = array( $product_id => $quantity );        }    }}function clear_cart(){    unset($_SESSION[request_sale_session_cart()]);    unset($_SESSION[request_sale_session_credit()]);}function add_credit(){    $credit = $_REQUEST[request_sale_credit()];    $creditname = $_REQUEST[request_sale_credit_name()];    if ($credit) {        $sessionCredit = $_SESSION[request_sale_session_credit()];        if ($sessionCredit) {            $sessionCredit[] = array($creditname, $credit);        }        else {            $sessionCredit = array(array($creditname, $credit));        }        $_SESSION[request_sale_session_credit()] = $sessionCredit;    }}function remove_credit(){    $credit_indice = $_REQUEST[request_sale_credit_indice()];    if ($credit_indice) {        $sessionCredit = $_SESSION[request_sale_session_credit()];        if ($sessionCredit) {            unset($sessionCredit[$credit_indice]);            $sessionCredit = array_values($sessionCredit);            $_SESSION[request_sale_session_credit()] = $sessionCredit;        }    }}function get_credit_total() {    return 0;}function get_tax_total() {    $taxpercent = str_replace('$', '', get_option('ctaxrate') / 100);    $subtotal = get_subtotal();    return $subtotal * $taxpercent;}function get_cart_books() {    $books = array();    foreach ($_SESSION[request_sale_session_cart()] as $product => $qty)    {        $price = get_book_saleprice($product);        $booktoadd = array($product, $qty, $price);        $books[] = $booktoadd;    }    return $books;}function get_credits() {    return array();}function get_next_invoice() {    $lastInvoice = get_option('_cmb_transaction_transaction_id');    return $lastInvoice + 1;}function set_last_invoice($lastInvoice) {    update_option('_cmb_transaction_transaction_id', $lastInvoice);}function state_select() {    ?>    <select name="AVSSTATE">        <option selected="selected" value="">        </option>        <option value="AL">            AL        </option>        <option value="AK">            AK        </option>        <option value="AZ">            AZ        </option>        <option value="AR">            AR        </option>        <option value="CA">            CA        </option>        <option value="CO">            CO        </option>        <option value="CT">            CT        </option>        <option value="DE">            DE        </option>        <option value="DC">            DC        </option>        <option value="FL">            FL        </option>        <option value="GA">            GA        </option>        <option value="HI">            HI        </option>        <option value="ID">            ID        </option>        <option value="IL">            IL        </option>        <option value="IN">            IN        </option>        <option value="IA">            IA        </option>        <option value="KS">            KS        </option>        <option value="KY">            KY        </option>        <option value="LA">            LA        </option>        <option value="ME">            ME        </option>        <option value="MD">            MD        </option>        <option value="MA">            MA        </option>        <option value="MI">            MI        </option>        <option value="MN">            MN        </option>        <option value="MS">            MS        </option>        <option value="MO">            MO        </option>        <option value="MT">            MT        </option>        <option value="NE">            NE        </option>        <option value="NV">            NV        </option>        <option value="NH">            NH        </option>        <option value="NJ">            NJ        </option>        <option value="NM">            NM        </option>        <option value="NY">            NY        </option>        <option value="NC">            NC        </option>        <option value="ND">            ND        </option>        <option value="OH">            OH        </option>        <option value="OK">            OK        </option>        <option value="OR">            OR        </option>        <option value="PA">            PA        </option>        <option value="RI">            RI        </option>        <option value="SC">            SC        </option>        <option value="SD">            SD        </option>        <option value="TN">            TN        </option>        <option value="TX">            TX        </option>        <option value="UT">            UT        </option>        <option value="VT">            VT        </option>        <option value="VA">            VA        </option>        <option value="WA">            WA        </option>        <option value="WV">            WV        </option>        <option value="WI">            WI        </option>        <option value="WY">            WY        </option>    </select>    <?php}?>