<?phpinclude_once 'bookmethods.php';include_once "extensions/includes.php";?><table border="0" cellpadding="0" cellspacing="0" width="100%">	<tr>		<form action="" id="library" method="post" name="library_search">			<td width="15%" align="left" valign="top" style="text-align: left;">				<table border="0" cellpadding="0" cellspacing="0" id="formtable" width="100%">					<tr>						<td align="right" width="7%"><label>ID:</label>&nbsp;</td>						<td width="93%"><input id="<?php echo request_consigner_id() ?>" name="<?php echo request_consigner_id() ?>" type="text"></td>					</tr>					<tr>						<td align="right" width="7%"><label>Name:</label>&nbsp;</td>						<td width="93%"><input id="<?php echo request_consigner_title() ?>" name="<?php echo request_consigner_title() ?>" type="text"></td>					</tr>                    <tr>                        <?php                        date_default_timezone_set('America/Chicago');                        ?>                        <td align="right" width="7%"><label>Date From:</label>&nbsp;</td>                        <td width="93%"><input id="<?php echo request_consigner_date_from() ?>" name="<?php echo request_consigner_date_from() ?>" type="date" value="<?php echo date("Y-m-d", mktime(0, 0, 0, 1, 1, 2000)); ?>"></td>                    </tr>                    <tr>                        <?php                        date_default_timezone_set('America/Chicago');                        ?>                        <td align="right" width="7%"><label>Date From:</label>&nbsp;</td>                        <td width="93%"><input id="<?php echo request_consigner_date_to() ?>" name="<?php echo request_consigner_date_to() ?>" type="date" value="<?php echo date('Y-m-d'); ?>"></td>                    </tr>					<tr>						<td width="35%">							<input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo query_search_action() ?>" />							<input class="button-primary" name="button" type="submit" value="Search" /></td>						<td></td>					</tr>				</table>			</td>		</form>		<td width="50%"></td>		<form width="30%" style="text-align: right;" method="POST" action="" name="adding_consigner">			<td style="float: right" valign="top" style="padding-left: 2px;">				<table id="formtable" border="0" cellspacing="0" cellpadding="0" class="inlineTable">					<tr>						<td align="right"><label>Name:</label></td>						<td style="padding-left: 5px;"><input type="text" name="<?php echo request_consigner_title() ?>"></td>					</tr>                    <tr>                        <?php                            date_default_timezone_set('America/Chicago');                        ?>                        <td align="right"><label>Date From:</label></td>                        <td style="padding-left: 5px;"><input type="date" name="<?php echo request_consigner_date_to() ?>" value="<?php echo date('Y-m-d'); ?>"></td>                    </tr>                    <tr>                        <td align="right"></td>                        <td align="center" style="padding-left: 5px;">                            <input type="hidden" name="<?php echo request_page_action() ?>" value="<?php echo add_consigner_action() ?>"/>                            <input type="submit" class="button-primary" value="Add Consigner"/>                        </td>                    </tr>				</table>			</td>		</form>	</tr>    <td colspan="5">        <hr/>    </td></table><?phpglobal $wpdb;switch ($_REQUEST[request_page_action()]) {	case query_search_action():		querySearch();		break;    case update_consigner_action():        update_consigner($_REQUEST[request_selected_consigner()]);        select_consigner($_REQUEST[request_selected_consigner()]);        break;    case add_consigner_action():        $consigner_id = add_consigner();        select_consigner($consigner_id);        break;    case consigner_select_action():        select_consigner($_REQUEST[request_selected_consigner()]);        break;    case search_consigner_books_action():        select_consigner($_REQUEST[request_selected_consigner()]);        break;    case add_book_to_consigner_action():        add_book_and_consigner($_REQUEST[request_selected_book()], $_REQUEST[request_selected_consigner()]);        select_consigner($_REQUEST[request_selected_consigner()]);        break;    case remove_book_from_consigner_action():        remove_book_and_consigner($_REQUEST[request_selected_book()], $_REQUEST[request_selected_consigner()]);        select_consigner($_REQUEST[request_selected_consigner()]);        break;};function querySearch(){	?>	<table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin: 10px 0 50px;">		<tr>			<th width="30%" align="left">Name</th>            <th width="auto" align="left">ID</th>            <th width="auto" align="left">Date</th>		</tr>		<?php		$args = array(			'numberposts' => -1,			'posts_per_page' => -1,			'order' => 'ASC',			'orderby' => 'date',			'post_type' => 'consigners'		);		$meta_query_array = array('relation' => 'OR');        if ($_REQUEST[request_consigner_title()]) {            $args['s'] = $_REQUEST[request_consigner_title()];        }		if ($_REQUEST[request_consigner_id()]) {			$meta_query_array[] = array(				'key' => '_cmb_consigner_id',				'value' => $_REQUEST[request_consigner_id()]			);		}        if ($_REQUEST[request_consigner_date_from()] || $_REQUEST[request_consigner_date_to()]) {            $meta_query_array[] =                array(                    'key' => '_cmb_consigner_date',                    'value' => array($_REQUEST[request_consigner_date_from()], $_REQUEST[request_consigner_date_to()]),                    'compare' => 'BETWEEN',                    'type' => 'DATE'                );        }		$args['meta_query'] = $meta_query_array;		$the_query = new WP_Query($args);		while ($the_query->have_posts()):			$the_query->the_post();			global $post;            $consigner_id = $post->ID;			consigner_display($consigner_id);		endwhile;		?>	</table>	<?php}function consigner_display($consigner_id) {    ?>    <tr>        <td>            <form method="POST" name="select_consigner">                <input type="hidden" name="<?php echo request_selected_consigner(); ?>" value="<?php echo $consigner_id ?>"/>                <?php store_query_info() ?>                <input name="<?php echo request_page_action(); ?>" type="hidden" value="<?php echo consigner_select_action(); ?>" />                <input style="                        background:none!important;                         border:none;                        padding:0!important;                        /*optional*/                        font-family:arial,sans-serif; /*input has OS specific font-family*/                        color:#069;                        cursor:pointer;"                       type="submit" name="button" class="button" value="<?php echo the_title(); ?>" />            </form>        </td>        <td><?php echo get_consigner_id($consigner_id); ?></td>        <td><?php echo get_consigner_date($consigner_id); ?></td>    </tr>    <?php}function select_consigner($consigner_post_id) {    $consigner_name = get_the_title($consigner_post_id);    $consigner_id = get_consigner_id($consigner_post_id);    if ($consigner_id == 0){        update_option('_cmb_consigner_owner', $consigner_post_id);    }    $search = $_REQUEST[request_consigner_book_search()] == 'true';    ?>    <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0">        <tr>            <td width="49%" valign="top">                <table id="formtable" border="0" cellspacing="0" cellpadding="0" style="margin: 10px 0 10px;">                    <tr>                        <form method="POST" action="" name="update_consigner" align="center">                            <td width="auto" align="left">                                <input style="width: 90%; padding: 4px 3px 4px" type="text"                                       id="<?php echo request_change_consigner_title(); ?>"                                       name="<?php echo request_change_consigner_title(); ?>"                                       value="<?php echo get_the_title($consigner_post_id); ?>"/>                            </td>                            <th width="auto" align="center"><h4><?php echo $consigner_id ?></h4></th>                            <td width="auto" align="left">                                <input style="width: 90%; padding: 4px 3px 4px" type="date"                                       id="<?php echo request_change_consigner_date(); ?>"                                       name="<?php echo request_change_consigner_date(); ?>"                                       value="<?php echo get_consigner_date($consigner_post_id); ?>"/>                            </td>                            <td width="10%" align="right">                                <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo update_consigner_action() ?>"/>                                <?php store_consigner_id() ?>                                <?php store_query_info() ?>                                <input type="submit" name="button" class="button-primary" value="Update"/>                            </td>                        </form>                        <td width="10%" align="right">                            <form method="POST" action="" name="back_to_query" align="center">                                <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo query_search_action() ?>"/>                                <?php store_query_info() ?>                                <input type="submit" name="button" class="button-primary" value="Back to Search Results"/>                            </form>                        </td>                    </tr>                    <tr>                        <td><h4 style="margin: 10px 0px 0px 0px;">Books</h4></td>                        <td><h4 style="margin: 10px 0px 0px 0px;">ISBN</h4></td>                        <td><h4 style="margin: 10px 0px 0px 0px;">Cost</h4></td>                        <td><h4 style="margin: 10px 0px 0px 0px;">Barcode</h4></td>                        <td width="6%"></td>                    </tr>                    <tr>                        <td colspan="5">                            <hr/>                        </td>                    </tr>                    <?php                    if ($consigner_id != 0) {                        $books = get_consigner_books($consigner_post_id);                        if (!empty($books)) {                            foreach ($books as $book) {                                book_display_consigner($book);                            }                        }                    }                    ?>                    <tr>                        <td><h4>Books Sold</h4></td>                        <td colspan="3">                            <hr/>                        </td>                        <td>                            <h4 align="center">Paid?</h4>                        </td>                    </tr>                    <?php                    if ($consigner_id != 0) {                        $soldbooks = get_consigner_sold_books($consigner_post_id);                        if (!empty($soldbooks)) {                            foreach ($soldbooks as $soldbook => $paid) {                                sold_book_display_consigner($soldbook, $paid);                            }                        }                    }                    ?>                </table>            </td>            <td width="2%"></td>            <td width="49%" valign="top">                <?php                if (!$search) {                    ?>                    <table id="formtable" align="left" border="0" cellspacing="0" cellpadding="0"                           style="margin: 10px 0 10px;">                        <tr>                            <th width="auto" align="left">Book Search</th>                        </tr>                        <?php                        book_table_search_input();                        ?>                        <tr>                            <td colspan="5">                                <hr/>                            </td>                        </tr>                    </table>                <?php                }                else {                    ?>                    <table id="formtable" align="left" border="0" cellspacing="0" cellpadding="0"                           style="margin: 10px 0 10px;">                        <tr>                            <th width="auto" align="left">Book Search</th>                        </tr>                        <?php                        book_table_search_input();                        ?>                        <tr>                            <td colspan="5">                                <hr/>                            </td>                        </tr>                        <?php                        book_table_results();                        ?>                    </table>                    <?php                }                ?>            </td>        </tr>    </table>    <?php}function book_table_search_input() {    ?>    <form action="" id="library" method="post" name="library_search">        <td width="15%" align="left" valign="top" style="text-align: left;">            <table border="0" cellpadding="0" cellspacing="0" id="formtable" width="100%">                <tr>                    <td align="right" width="7%"><label>Title:</label>&nbsp;</td>                    <td width="93%"><input id="<?php echo request_book_title() ?>" name="<?php echo request_book_title() ?>" type="text"></td>                </tr>                <tr>                    <td align="right" width="7%"><label>ID:</label>&nbsp;</td>                    <td width="93%"><input id="<?php echo request_book_barcode() ?>" name="<?php echo request_book_barcode() ?>" type="text"></td>                </tr>                <tr>                    <td align="right" width="7%"><label>ISBN:</label>&nbsp;</td>                    <td width="93%"><input id="<?php echo request_book_isbn() ?>" name="<?php echo request_book_isbn() ?>" type="text"></td>                </tr>                <tr>                    <td align="right" width="7%"><label>Publisher:</label>&nbsp;</td>                    <td width="93%"><input id="<?php echo request_book_publisher() ?>" name="<?php echo request_book_publisher() ?>" type="text"></td>                </tr>                <tr>                    <td align="right" width="7%"><label>Price:</label>&nbsp;$&nbsp;</td>                    <td width="93%"><input id="<?php echo request_book_price() ?>" name="<?php echo request_book_price() ?>" type="text"></td>                </tr>                <tr>                    <td width="35%">                        <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo search_consigner_books_action() ?>" />                        <input name="<?php echo request_consigner_book_search() ?>" type="hidden" value="true" />                        <?php store_consigner_id(); ?>                        <input class="button-primary" name="button" type="submit" value="Search" /></td>                    <td></td>                </tr>            </table>        </td>        <td width="18%" align="left" valign="top" style="text-align: left;">            <table border="0" cellpadding="0" cellspacing="0" id="formtable" width="100%">                <tr>                    <td align="right"><label>Department:</label></td>                    <td style="padding-left: 5px;"><?php                        wp_dropdown_categories(array(                            'hide_empty' => 0,                            'name' => request_book_category(),                            'hierarchical' => true,                            'show_option_all' => 'Choose one'                        ));                        ?></td>                </tr>                <tr>                    <td align="right"><label>Availability:</label></td>                    <td style="padding-left: 5px;">&nbsp;&nbsp;<input type="radio" name="<?php echo request_book_availability() ?>" value="Active">                        Active&nbsp;&nbsp;&nbsp;<input                            type="radio" name="<?php echo request_book_availability() ?>" value="Inactive"> Inactive                    </td>                </tr>            </table>        </td>    </form>    <?php}function book_table_results(){    $barcode_id        = $_REQUEST[request_book_barcode()];    $query_title     = $_REQUEST[request_book_title()];    $ISBN              = $_REQUEST[request_book_isbn()];    $query_publisher = $_REQUEST[request_book_publisher()];    $query_available = $_REQUEST[request_book_availability()];    $query_category = $_REQUEST[request_book_category()];    ?>    <table id="formtable" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin: 10px 0 50px;">        <tr>            <th width="30%" align="left">Title</th>            <th width="auto" align="left">ISBN</th>            <th width="auto" align="left">Publisher</th>            <th width="auto" align="left">Barcode</th>        </tr>        <tr>            <td colspan="4">                <hr/>            </td>        </tr>        <?php        $args = array(            'numberposts' => -1,            'posts_per_page' => 15,            'order' => 'ASC',            'orderby' => 'date',            'post_type' => 'bookstore'        );        $meta_query_array = array('relation' => 'AND');        if ($_REQUEST[request_book_barcode()]) {            $meta_query_array[] = array(                'key' => '_cmb_resource_barcode',                'value' => $barcode_id            );            $args['exact'] = 1;            $args['numberposts'] = 1;        }        else {            if ($_REQUEST[request_book_title()]) {                $args['s'] = $query_title;            }            if ($_REQUEST[request_book_category()]) {                $args['cat'] = $query_category;            }            if ($_REQUEST[request_book_publisher()]) {                $meta_query_array[] = array(                    'key' => '_cmb_resource_publisher',                    'value' => $query_publisher                );            }            if ($_REQUEST[request_book_isbn()]) {                $ISBN = str_replace('U', '', $ISBN) . 'U';                $meta_query_array[] = array(                    'key' => '_cmb_resource_u-sku',                    'value' => $ISBN                );                $meta_query_array[] = array(                    'key' => '_cmb_resource_sku',                    'value' => $ISBN                );            }            if ($_REQUEST[request_book_availability()]) {                $meta_query_array[] = array(                    'key' => '_cmb_resource_condition',                    'value' => $query_available                );            }        }        $meta_query_array[] = array(            'key' => '_cmb_resource_condition',            'value' => 'Used'        );        $args['meta_query'] = $meta_query_array;        $the_query = new WP_Query($args);        while ($the_query->have_posts()):            $the_query->the_post();            global $post;            $product_id = $post->ID;            book_display($product_id);        endwhile;        ?>    </table>    <?php}function book_display__($product_id) {    ?>    <tr>        <td><?php echo get_the_title($product_id); ?></td>        <td><?php echo get_book_sku($product_id); ?></td>        <td><?php echo get_book_publisher($product_id); ?></td>        <td><?php echo get_book_barcode($product_id); ?></td>        <td>            <form method="POST" action="" name="add_book_to_consigner" align="center">                <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo add_book_to_consigner_action() ?>"/>                <?php                    store_query_info();                    store_consigner_id();                    store_query_book_info();                ?>                <input name="<?php echo request_selected_book() ?>" type="hidden" value="<?php echo $product_id; ?>" />                <input type="submit" name="button" class="button-primary" value="Add"/>            </form>        </td>    </tr>    <?php}function book_display_consigner($product_id) {    ?>    <tr>        <td><?php echo get_the_title($product_id); ?></td>        <td><?php echo get_book_sku($product_id); ?></td>        <td><?php echo get_book_cost($product_id); ?></td>        <td><?php echo get_book_barcode($product_id); ?></td>        <td>            <form method="POST" action="" name="remove_book_to_consigner" align="center">                <input name="<?php echo request_page_action() ?>" type="hidden" value="<?php echo remove_book_from_consigner_action() ?>"/>                <?php                store_query_info();                store_consigner_id();                store_query_book_info();                ?>                <input name="<?php echo request_selected_book() ?>" type="hidden" value="<?php echo $product_id; ?>" />                <input type="submit" name="button" class="button-primary" value="Remove"/>            </form>        </td>    </tr>    <?php}function sold_book_display_consigner($product_id, $paid) {    ?>    <tr>        <td><?php echo get_the_title($product_id); ?></td>        <td><?php echo get_book_sku($product_id); ?></td>        <td><?php echo get_book_cost($product_id); ?></td>        <td><?php echo get_book_barcode($product_id); ?></td>        <td align="center"><?php echo $paid; ?></td>    </tr>    <?php}function store_query_info() {    ?>    <input name="<?php echo request_consigner_id() ?>" type="hidden" value="<?php echo $_REQUEST[request_consigner_id()]; ?>" />    <input name="<?php echo request_consigner_title() ?>" type="hidden" value="<?php echo $_REQUEST[request_consigner_title()]; ?>" />    <?php}function store_query_book_info() {    if ($_REQUEST[request_book_barcode()] || $_REQUEST[request_book_title()] || $_REQUEST[request_book_isbn()] || $_REQUEST[request_book_publisher()] || $_REQUEST[request_book_category()] || $_REQUEST[request_book_availability()]){        ?>        <input name="<?php echo request_consigner_book_search() ?>" type="hidden" value="true" />        <?php    }    else {        ?>        <input name="<?php echo request_consigner_book_search() ?>" type="hidden" value="false" />        <?php    }    ?>    <input name="<?php echo request_book_barcode() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_barcode()]; ?>" />    <input name="<?php echo request_book_title() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_title()]; ?>" />    <input name="<?php echo request_book_isbn() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_isbn()]; ?>" />    <input name="<?php echo request_book_publisher() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_publisher()]; ?>" />    <input name="<?php echo request_book_category() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_category()]; ?>" />    <input name="<?php echo request_book_availability() ?>" type="hidden" value="<?php echo $_REQUEST[request_book_availability()]; ?>" />    <?php}function store_consigner_id(){    ?>    <input name="<?php echo request_selected_consigner() ?>" type="hidden" value="<?php echo $_REQUEST[request_selected_consigner()]; ?>" />    <?php}?>